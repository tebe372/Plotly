---
title: "An introduction to plotly's R API"
author: "Carson Sievert"
output: html_document
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Plotly DSL}
---

```{r setup, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(eval = FALSE)
```

Version 1.0.0 of the [plotly R package](https://github.com/ropensci/plotly) introduces a new interface for creating plotly graphs in a [pure, predictable, and pipeable](https://dl.dropboxusercontent.com/u/41902/pipe-dsls.pdf) manner. This interface makes it a bit easier to work directly with the JavaScript graphing library by providing some high-level semantics and sensible defaults.

## Creating and modifying plotlys

To initiate a plotly object, use `plot_ly()`. Here we use it to create a scatter trace (but there are many [other trace types](https://plot.ly/r/)).

```{r}
library(plotly)
p <- plot_ly(economics, x = date, y = uempmed, type = "scatter", showlegend = F)
```

If you have a plotly account, printing plotly objects in the R console will create a new plotly figure (via plotly's REST API). If you're using knitr/R Markdown with HTML output (like [this vignette]()), printing not only creates the plot, but also embeds it as an HTML iframe. If you want to create standalone HTML pages, check out [plotly offline](http://purchasing.plot.ly/) and the accompanying [vignette for R]().

```{r}
p
```

## Using special arguments

`plot_ly()` has a number of arguments which are unique to the R package that make common visualization tasks a bit easier. These arguments are very much inspired by the semantics of ggplot2's `qplot()` in the sense that a scaling function is automatically applied these variables.

### The color argument

If a ordinal variable (aka a non-ordered factor variable) is mapped to color, then a qualitative color pallete is used by default.

```{r}
plot_ly(iris, x = Petal.Length, y = Petal.Width, 
        color = Species, mode = "markers")
```

<a href="https://plot.ly/~agvd/414"> 
  <img src="https://plot.ly/~agvd/414.png">
</a>

If you want to change the default pallette, you can give the colors argument either a <http://colorbrewer2.org> pallette name (e.g., "Set1" or "Blues"), or a vector of colors to interpolate in hexadecimal "#RRGGBB" format, or a color interpolation function like `grDevices::colorRamp()`.

```{r}
plot_ly(iris, x = Petal.Length, y = Petal.Width, 
        color = Species, colors = "Set1", mode = "markers")
```

<a href="https://plot.ly/~agvd/428"> 
  <img src="https://plot.ly/~agvd/428.png">
</a>

```{r}
plot_ly(iris, x = Petal.Length, y = Petal.Width, z = Sepal.Width,
        color = Sepal.Length, type = "scatter3d", mode = "markers")
```


### The symbol argument



### The group argument

This can be useful when used in conjunction with `subplot()` (link to a separate vignette?)

## Manually adding traces

Sometimes you want to add trace(s) to a plot that derive from a different data frame. 

To add more traces to your plotly, use `add_trace()`. By default, trace information created in `plot_ly()` will carry over to future traces, unless we explictly override it (this helps [avoid repeating yourself](http://en.wikipedia.org/wiki/Don%27t_repeat_yourself)).

```{r}
p2 <- add_trace(p, y = fitted(loess(uempmed ~ as.numeric(date))))
p2
```

To modify the styling of the plot, use `layout()`.

```{r}
(p3 <- layout(p2, title = "Median duration of unemployment (in weeks)"))
```

The documentation for valid arguments to `layout()` are under [plotly's R reference](https://plot.ly/r/reference/#layout). In addition to title (a string) , `layout()` also accepts [font](https://plot.ly/r/reference/#font) (a named list). Lets use this argument to change the default font family and size:

```{r}
layout(p3, font = list(family = "Courier New, monospace", size = 10))
```

If you look at the structure of plotly objects, they are data frames with a class of plotly and a special environment attached. 

```{r}
str(p3)
```

This might seem strange, but it yields desirable results since it integrates nicely with other pipeable interfaces that use a data frame their central object (such as [dplyr](http://cran.r-project.org/web/packages/dplyr/index.html)). This means that we can incorporate data manipulation verbs into a sequence of steps leading to a visualization. Here, we take advantage of `dplyr::filter()` to label the highest peak in the time series:

```{r, message = FALSE, warning = FALSE}
economics %>%
  plot_ly(x = date, y = uempmed, type = "scatter", showlegend = F) %>%
  add_trace(y = fitted(loess(uempmed ~ as.numeric(date)))) %>%
  layout(title = "Median duration of unemployment (in weeks)") %>%
  dplyr::filter(uempmed == max(uempmed)) %>%
  # annotations is an array of objects (in R, that's a list of named list(s))
  layout(annotations = list(list(x = date, y = uempmed, text = "Peak", showarrow = T)))
```

It's also important to note that plotly visualization don't _require_ a data frame. Chart types that accept a `z` argument 

```{r}
str(volcano)
plot_ly(z = volcano, type = "surface")
```

### Figure objects

Figure objects are plotly objects, but with a fixed location. That is, when you print a figure object, it modifies the already existing plotly (instead of creating a new one). The proper way to initiate a figure object is with `get_figure()`:

```{r}
fig <- get_figure("TestBot", "17555")
layout(fig, title = paste("Last modified ", Sys.time()))
```

If you want to modify the styling of trace(s), use `style()`.

### `ggplot2` objects

The `ggplotly()` function converts a ggplot object to a plotly object. 

```{r}
library(ggplot2)
(gg <- ggplotly(qplot(mpg, wt, data = mtcars)))
```

This means we can alter (converted) ggplot(s) as if they were plotly object(s).

```{r}
layout(gg, font = list(family = "Courier New, monospace"))
```

### Multiple plots

ggplot2's `facet_wrap()` and `facet_grid()` are a nice way to produce [small multiples](http://en.wikipedia.org/wiki/Small_multiple), but sometimes you want more flexibility in laying out multiple plots in a single view. Advanced ggplot2 users might be familiar with using grid or [gridExtra package](http://lightonphiri.org/blog/ggplot2-multiple-plots-in-one-graph-using-gridextra) for this sort of thing, but these approaches communicate directly with R's graphics devices, so that approach won't work for plotly.

Thankfully, plotly provides a `subplots()` function:

```{r}
a1 <- layout(p2, title = "Median duration of unemployment (in weeks)")
a2 <- plot_ly(economics, x = date, y = unemploy, showlegend = F)
subplot(a1, a2)
```

By default, `subplot()` will assume you want all your plots in a single row. Use the `nrows` argument to change that default:

```{r}
subplot(a1, a2, nrows = 2)
```

You can also manually add xaxis/yaxis domain information. In fact, this approach makes it fairly easy to create [inset plots](https://plot.ly/javascript-graphing-library/insets/). 

```{r}
a2_small <- layout(a2, 
                   xaxis = list(domain = c(0.05, 0.35)), 
                   yaxis = list(domain = c(0.7, 1)))
subplot(a1, a2_small)
```
